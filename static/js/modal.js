(function(){function g(a,b,c){if(a.addEventListener)a.addEventListener(b,c,!1);else{c.$$guid||(c.$$guid=g.guid++),a.events||(a.events={});var d=a.events[b];d||(d=a.events[b]={},a["on"+b]&&(d[0]=a["on"+b]),a["on"+b]=i),d[c.$$guid]=c}}function h(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.events&&a.events[b]&&c.$$guid&&delete a.events[b][c.$$guid]}function i(a){a=a||j(window.event);var b=!0,c=this.events[a.type];for(var d in c)Object.prototype[d]||(this.$$handler=c[d],this.$$handler(a)===!1&&(b=!1));return this.$$handler&&(this.$$handler=null),b}function j(a){return a.preventDefault=j.preventDefault,a.stopPropagation=j.stopPropagation,a}function k(a,b){l(a,b),a.className=(a.className||"")+" "+b}function l(a,b){a.className=(a.className||"").replace(new RegExp(b,"g"),"").replace(/^\s+|\s+$/g,"")}function m(a,b){var c=(a.className||"").split(" ");for(var d=0;d<c.length;d++)if(c[d].toLowerCase()===b.toLowerCase())return!0;return!1}function n(a,b){for(var c=0,d=a.length;c<d;c++)b.call(null,a[c],c)}function o(a,b){var c=[];return n(a,function(a,d){b.call(null,a,d)&&c.push(a)}),c}function p(a,b,c){c||(c="*"),b=b||{},b.type=a,window.parent.postMessage(JSON.stringify(b),c)}function q(){return window.location.search[1]==="s"}function r(a,b){if(q()){p(a,b,window.location.protocol+"//"+window.location.host);return}b=b||{},b.type=a;for(var c=0;c<window.parent.frames.length;c++)try{if(window.parent.frames[c].location.pathname==="/bookmarklet/bookmarklet"){window.parent.frames[c].postMessage(JSON.stringify(b),bookmarkletHost);break}}catch(d){}}function s(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a.apply(this,b.concat(Array.prototype.slice.call(arguments)))}}function t(){p("closeMeta"),r("closeMeta"),k(document.body,"hidden")}function u(){C(null,t)}function v(a){return Object.prototype.toString.call(a)=="[object Array]"}function w(b){if(!b)return"";var c="";for(var d in b)v(b[d])?n(b[d],function(a){c+=encodeURIComponent(d+"[]")+"="+encodeURIComponent(a)+"&"}):c+=encodeURIComponent(d)+"="+encodeURIComponent(b[d])+"&";return c+="_csrf="+a,c}function x(a){return a}function y(a){function b(){var b=a.success||x,c=a.error||x,d=a.complete||x;this.readyState===4&&(this.status>=200&&this.status<300?b.call(null,JSON.parse(this.responseText),this):c.call(null,JSON.parse(this.responseText),this),d.call(),l(e(".modal"),"xhr-send"))}var c=new XMLHttpRequest,d=a.url,f=w(a.data);f&&(a.method.toLowerCase()==="get"||a.method.toLowerCase()==="delete")&&(d+="?"+f,f=undefined),c.open(a.method,d,!0),a.method.toLowerCase()==="post"&&c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.onreadystatechange=b,k(e(".modal"),"xhr-send"),c.send(f)}function z(a,b){a.collections=o(a.collections,function(a){return a.id!==b.id}),r("assetUpdated",{asset:{id:a.id,collections:a.collections}}),y({url:"/site-api-1/collection/"+b.id+"/assets",data:{asset_id:[a.id]},method:"DELETE",success:function(){var a=document.getElementById("collection-"+b.id);a.parentNode.removeChild(a)}})}function A(a,b){a.collections.push(b),r("assetUpdated",{asset:{id:a.id,collections:a.collections}});var c=e(".collections-added");y({url:"/site-api-1/collection/"+b.id+"/assets",data:{asset_id:[a.id]},method:"POST",success:s(B,c,a,b)})}function B(a,b,c){var d=document.createElement("li");d.className="collection",c.special&&(d.className+=" is-special"),d.id="collection-"+c.id,d.innerHTML='<span class="icon">&times;</span>';var e=document.createElement("span");e.className="name",e.appendChild(document.createTextNode(c.title)),d.insertBefore(e,d.firstChild),a.appendChild(d),g(d.querySelector(".icon"),"click",s(z,b,c)),p("collectionsHeight",{height:a.offsetHeight})}function C(a,b){b||(b=function(){});var c=document.getElementById("asset_id").value;if(!c)return;var f=e(".title").value,g=e(".comment").value,h=document.getElementById("collection-private").checked;f!==d.title||g!==d.description||h!==d["private"]?y({url:"/site-api-1/asset/"+c,method:"POST",data:{title:f,description:g,"private":h?"1":"0",_extension:["elsewhere","description"]},success:function(a){Z(),d=a,r("assetUpdated",{asset:d}),D(d)},complete:b}):b.call(null)}function D(a){document.getElementById("asset_id").value=a.id,e(".title").value=a.title,e(".comment").value=a.description;var b=e(".collections-added");b.innerHTML="",n(a.collections,function(c){B(b,a,c)}),l(document.body,"is-private"),a["private"]&&k(document.body,"is-private");var c="http://"+shortUrlHost+"/"+a.short_url_token;e(".share-twitter").href="https://twitter.com/?status="+encodeURIComponent(c+" /via @gimmebar");var d=e(".share .url");d.value="gim.ie/"+a.short_url_token,a["private"]?document.getElementById("collection-private").checked=!0:document.getElementById("collection-public").checked=!0}function E(a){var b;return n(c,function(c){if(b)return;c.id===a&&(b=c)}),b}function F(e){switch(e.type){case"asset":d=e.asset,D(d),e.editable&&k(document.body,"is-mine");break;case"bookmarkletData":c=e.collections.records,a=e.csrf_token,b=e.tags;break;case"closeMeta":u()}}function G(a,b){if(b==="")return[];b=b.toLowerCase();var d=[];return n(c,function(c){c.title.toLowerCase().indexOf(b)!==-1&&(a?c["private"]&&d.push(c):d.push(c))}),d}function H(a){A(d,a),I()}function I(){l(document.body,"is-autocompleting");var a=e(".collections-wrap .autocomplete-match");a.innerHTML=""}function K(a,b){I();var c=e(".collections-wrap .autocomplete-match"),d=J===-1?' class="is-active"':"";b!==""&&(c.innerHTML='<li id="collection-new"'+d+">Create <em>"+b+"</em></li>");var f=0;k(document.body,"is-autocompleting"),n(a,function(a){var d=document.createElement("li");d.id="collection-"+a.id,f===J&&(d.className="is-active");var e=a.title.toLowerCase().indexOf(b.toLowerCase()),h=a.title.substring(0,e);d.appendChild(document.createTextNode(h));var i=document.createElement("span");d.appendChild(i),i.appendChild(document.createTextNode(b)),d.appendChild(document.createTextNode(a.title.substring(e+b.length,a.title.length))),c.appendChild(d),g(d,"click",s(H,a)),f++})}function L(a){y({url:"/site-api-1/collection",data:{title:a,"private":d["private"]},method:"POST",success:function(a){c.push(a),A(d,a)}})}function M(a){if(a.keyCode===38||a.keyCode===40)return a.preventDefault(),!1}function N(a){var b=a.value,c=T(a);for(var d=b.length-1;d>=0;d--){if(b[d]==="#")return!0;if(b[d].match(/\s/))return!1}return!1}function O(a){var b=a.value,c=T(a),d,e;for(d=c;d>=0;d--)if(b[d]==="#")break;for(e=c;e<b.length;e++)if(b[e].match(/\s/))break;return b.substring(d+1,e)}function P(a){var c=O(a);if(!c)return[];var d=[],e=3;for(var f=0;f<b.length;f++){b[f].indexOf(c)===0&&d.push(b[f]);if(d.length>=e)break}return d}function Q(){var a=e(".comment-wrap .autocomplete-match");a.innerHTML=""}function R(a){var b=e(".comment-wrap .autocomplete-match");Q(),n(a,function(a,c){var d;c===W?d="is-active":d="";var e=document.createElement("li");e.className=d,e.appendChild(document.createTextNode(a)),b.appendChild(e)})}function S(a){var b=2,c=!1;switch(a.keyCode){case 9:return;case 27:u();return;case 38:J--;break;case 40:J++;break;case 13:var f=e(".is-active").id.split("-")[1];if(f==="new")L(a.target.value);else{var g=E(f);A(d,g)}I(),J=0,a.target.value="";return;default:c=!0}var h=G(d["private"],a.target.value).slice(0,b),i=Math.min(b,h.length);return J<-1&&(J=i-1),J>=i&&(J=-1),i!==0&&(i!==1||J!==-1)&&(J%=i),J===-1&&c&&(J=0),K(h,a.target.value),!1}function T(a){if("selectionStart"in a&&document.activeElement===a)return a.selectionStart;if(a.createTextRange){var b=document.selection.createRange(),c=a.createTextRange();if(c.inRange(b))return c.setEndPoint("EndToStart",b),c.text.length}return-1}function U(a){if(a.keyCode===38||a.keyCode===40||a.keyCode===13)if(N(a.target))return a.preventDefault(),!1}function V(a,b){var c,d=T(a);for(c=d;c>=0;c--)if(a.value[c]==="#")break;a.value=a.value.substring(0,c+1)+b+" "+a.value.substring(d,a.value.length)}function X(a){var b=3;switch(a.keyCode){case 27:u();return;case 38:W--;break;case 40:W++;break;case 13:var c=e(".comment-wrap .is-active");if(c){W=-1;var d=c.innerHTML;return Q(),V(a.target,d),!1}return;default:}if(N(a.target)){var f=P(a.target).slice(0,b),g=Math.min(b,f.length);W<-1&&(W=g-1),g!==0?W%=g:W=-1,R(f)}e(".comment").value!=""?Y():Z()}function Y(){var a=e(".comment"),b=a.scrollHeight;b<=100?a.style.height=b+"px":a.style.height="100px";var c=parseInt(a.style.height,10);c>20&&p("collectionsHeight",{height:c-20})}function Z(){var a=e(".comment");a.style.height="20px",p("collectionsHeight",{height:0})}function _(a,b,c,d,f,g){var h=e(a),i=h.getContext("2d"),j={fillStyle:g.fillStyle||"#eee",lineWidth:g.lineWidth||1,strokeStyle:g.strokeStyle||"rgba(0, 0, 0, .1)"};h.width=h.width,i.fillStyle=j.fillStyle,i.lineWidth=j.lineWidth,i.strokeStyle=j.strokeStyle,i.beginPath(),q()?(i.moveTo(b+j.lineWidth,f+j.lineWidth),i.lineTo(b+d-j.lineWidth,f+j.lineWidth),i.lineTo(b+d/2,c-j.lineWidth),i.lineTo(b+j.lineWidth,f+j.lineWidth)):(i.moveTo(b+j.lineWidth,c+j.lineWidth),i.lineTo(b+d-j.lineWidth,c+j.lineWidth),i.lineTo(b+d/2,c+f-j.lineWidth),i.lineTo(b+j.lineWidth,c+j.lineWidth)),i.stroke(),i.fill(),i.closePath()}var a,b=[],c=[],d,e=function(a){return document.querySelector(a)},f=function(){function a(){var a=document.createElement("input"),c,d,e,f;return typeof a.placeholder=="undefined"&&(c=document.createElement("style"),c.type="text/css",d=document.createTextNode(".placeholderspolyfill { color:#999 !important; }"),c.styleSheet?c.styleSheet.cssText=d.nodeValue:c.appendChild(d),document.getElementsByTagName("head")[0].appendChild(c),Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){for(e=b||0,f=this.length;e<f;e++)if(this[e]===a)return e;return-1}),b()),!1}function b(){var a=document.getElementsByTagName("input"),b=document.getElementsByTagName("textarea"),c=a.length,e=c+b.length,f,h,i,j;for(f=0;f<e;f++){h=f<c?a[f]:b[f-c],j=h.getAttribute("placeholder");if(j){h.setAttribute("data-currentplaceholder",j);if(h.value===""||h.value===j)h.className=h.className+" placeholderspolyfill",h.value=j;h.form&&(i=h.form,i.getAttribute("data-placeholdersubmit")||(i.addEventListener?i.addEventListener("submit",function(){g(i)},!1):i.attachEvent&&i.attachEvent("onsubmit",function(){g(i)}),i.setAttribute("data-placeholdersubmit","true"))),d(h)}}}function c(){var a=document.getElementsByTagName("input"),b=document.getElementsByTagName("textarea"),c=a.length,e=c+b.length,f,g,h,i;for(f=0;f<e;f++){g=f<c?a[f]:b[f-c],i=g.getAttribute("placeholder");if(i){h=g.getAttribute("data-currentplaceholder");if(i!==h){if(g.value===h||g.value===i||!g.value)g.value=i,g.className=g.className+" placeholderspolyfill";h||d(g),g.setAttribute("data-currentplaceholder",i)}}}}function d(a){a.addEventListener?(a.addEventListener("focus",function(){e(a)},!1),a.addEventListener("blur",function(){f(a)},!1)):a.attachEvent&&(a.attachEvent("onfocus",function(){e(a)}),a.attachEvent("onblur",function(){f(a)}))}function e(a){a.value===a.getAttribute("placeholder")&&(a.className=a.className.replace(/\bplaceholderspolyfill\b/,""),a.value="")}function f(a){a.value===""&&(a.className=a.className+" placeholderspolyfill",a.value=a.getAttribute("placeholder"))}function g(a){var b=a.getElementsByTagName("input"),c=a.getElementsByTagName("textarea"),d=b.length,e=d+c.length,f,g,h;for(h=0;h<e;h++)f=h<d?b[h]:c[h-d],g=f.getAttribute("placeholder"),f.value===g&&(f.value="")}return{init:a,refresh:c}}();g.guid=1,j.preventDefault=function(){this.returnValue=!1},j.stopPropagation=function(){this.cancelBubble=!0},window.addEventListener||(document.onreadystatechange=function(){window.onload&&window.onload!=i&&(g(window,"load",window.onload),window.onload=i)}),window.addEventListener("message",function(a){var b=JSON.parse(a.data);bookmarkletHost===a.origin&&(origin=a.origin,originUrl=b.url,ownerWindow=a.source,F(b))},!1);var J=0,W=-1;g(e(".close"),"click",u),g(e(".title"),"blur",C),g(e(".title"),"keyup",function(a){a.which===13&&C()}),g(e(".comment"),"focus",function(a){k(e(".comment").parentNode,"is-focus"),e(".comment").value!=""?Y():Z()}),g(e(".comment"),"blur",function(){C(),l(e(".comment").parentNode,"is-focus")}),g(e(".collections"),"keyup",S),g(e(".collections"),"keydown",M),g(e(".delete"),"click",function(a){return k(e(".footer"),"is-delete"),a.preventDefault(),!1}),g(e(".cancel-delete"),"click",function(a){return l(e(".footer"),"is-delete"),a.preventDefault(),!1}),g(e(".confirm-delete"),"click",function(a){return k(e(".footer"),"is-deleting"),p("delete",d),a.preventDefault(),!1}),g(e(".privacy"),"change",C),g(e(".comment"),"keyup",X),g(e(".comment"),"keydown",U),g(e(".share .url"),"mouseup",function(a){a.target.select()});var $={strokeStyle:"#bababa"};q()?$.fillStyle="#fff":$.fillStyle="#FAFAFA",_(".modal .pointer",0,0,40,20,$),q()&&(document.body.className+=" is-site")})();